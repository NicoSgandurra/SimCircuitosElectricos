<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Avanzado de Motor PaP (v6)</title>
    
    <style>
        /* --- 1. TU C√ìDIGO CSS (PASTELES) --- */
        :root {
            /* Modo Claro (Verde Agua/Menta Pastel) */
            --bg-color: #f0fdf4;
            --card-bg: #ffffff;
            --text-color: #2e4a4a;
            --text-light: #6a9c9c;
            --border-color: #d2f0e0;
            --primary-color: #5ab17c;
            --primary-hover: #4a9e6b;
            --danger-color: #e76f51; /* Rojo brillante para el polo Norte del rotor */
            --danger-hover: #d05c43;
            --code-bg: #e0f2f7;
            --shadow: 0 4px 12px rgba(0,0,0,0.05);
            --shadow-hover: 0 6px 16px rgba(0,0,0,0.1);
            
            /* --- Colores Personalizados del Motor --- */
            --motor-estator: #eceff1;
            --motor-estator-borde: var(--border-color);
            
            /* Colores del Rotor (Rojo = NORTE, Azul = SUR) */
            --motor-rotor-norte: var(--danger-color); 
            --motor-rotor-sur: #3498db; /* Un azul claro */
            
            /* --- CAMBIO CLAVE: Colores de Polaridad de BOBINAS --- */
            /* Bobina que crea un polo NORTE (rojo pastel) */
            /* Esta atraer√° el polo SUR (azul) del rotor */
            --motor-bobina-crea-norte: #f5b7b1; /* Rojo Pastel */

            /* Bobina que crea un polo SUR (celeste pastel) */
            /* Esta atraer√° el polo NORTE (rojo) del rotor */
            --motor-bobina-crea-sur: #a9cce3; /* Celeste Pastel */

            --motor-bobina-off: #dfe6e9;
        }

        body.dark-mode {
            /* Modo Oscuro (Morado/Lavanda Pastel) */
            --bg-color: #1a1523;
            --card-bg: #28203d;
            --text-color: #e6e0f0;
            --text-light: #afa2c3;
            --border-color: #43386b;
            --primary-color: #a78bfa;
            --primary-hover: #9175d6;
            --danger-color: #ef778a;
            --danger-hover: #d56073;
            --code-bg: #3d305e;
            --shadow: 0 4px 12px rgba(0,0,0,0.2);
            --shadow-hover: 0 6px 16px rgba(0,0,0,0.3);

            /* --- Colores Motor (Oscuro) --- */
            --motor-estator: #3d305e;
            --motor-estator-borde: var(--border-color);
            --motor-bobina-off: #5b517d;

            /* --- CAMBIO CLAVE: Colores de Polaridad (Oscuro) --- */
            --motor-bobina-crea-norte: #d98880; /* Rojo Pastel (oscuro) */
            --motor-bobina-crea-sur: #74a4c4; /* Celeste Pastel (oscuro) */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        h1, h2, h3 { color: var(--primary-color); transition: color 0.3s ease; }
        h1 { text-align: center; }
        h2 { border-bottom: 2px solid var(--border-color); padding-bottom: 5px; }
        
        button {
            padding: 10px 15px;
            font-size: 16px;
            border-radius: 5px;
            border: none;
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease, color 0.3s ease;
        }
        button:hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }
        button:disabled {
            background-color: var(--text-light);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        button.danger { background-color: var(--danger-color); }
        button.danger:hover { background-color: var(--danger-hover); }

        /* --- 3. Contenedores (Tarjetas) --- */
        .simulador-card, .controles, .estado-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-top: 20px;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .controles {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        #darkModeToggle {
            background-color: transparent;
            color: var(--text-color);
            font-size: 24px;
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 45px;
            height: 45px;
            padding: 0;
            margin-left: auto;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        #darkModeToggle:hover {
            background-color: var(--code-bg);
            transform: translateY(-2px) rotate(15deg);
        }

        /* --- 4. ESTILOS DEL SIMULADOR --- */

        .simulador-card {
            display: flex;
            justify-content: center;
            align-items: center;
            padding-top: 40px;
            padding-bottom: 40px;
            overflow: hidden;
        }
        
        #estator {
            position: relative;
            width: 320px;
            height: 320px;
            border: 10px solid var(--motor-estator-borde);
            border-radius: 50%;
            background-color: var(--motor-estator);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        #rotor {
            position: absolute;
            width: 200px;
            height: 40px;
            /* Rotor con colores Norte (Rojo) y Sur (Azul) */
            background: linear-gradient(90deg, var(--motor-rotor-norte) 48%, #333 48%, #333 52%, var(--motor-rotor-sur) 52%);
            border: 4px solid #333;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            top: 50%;
            left: 50%;
            margin-left: -100px;
            margin-top: -20px; 
            transition: transform 0.15s ease-in-out; 
            transform-origin: center;
            transform: rotate(0deg);
        }
        
        .bobina {
            position: absolute;
            width: 60px;
            height: 60px;
            background-color: var(--motor-bobina-off);
            border: 4px solid var(--motor-estator-borde);
            border-radius: 15px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
            transition: background-color 0.1s ease, border-color 0.3s ease, color 0.3s ease, transform 0.1s ease;
            top: 50%;
            left: 50%;
            margin: -30px;
        }
        
        /* --- CAMBIO CLAVE: Clases de Polaridad (¬°Ahora s√≠, correctas!) --- */
        /* Bobina crea polo NORTE (rojo pastel) */
        /* -> Atraer√° el polo SUR (azul) del rotor */
        .energizada-norte {
            background-color: var(--motor-bobina-crea-sur);
            border-color: var(--motor-rotor-sur); /* Borde azul */
            color: #333;
            transform: scale(1.05);
        }
        /* Bobina crea polo SUR (celeste pastel) */
        /* -> Atraer√° el polo NORTE (rojo) del rotor */
        .energizada-sur {
            background-color: var(--motor-bobina-crea-norte);
            border-color: var(--motor-rotor-norte); /* Borde rojo */
            color: #333;
            transform: scale(1.05);
        }
        
        /* Posicionamiento de las 6 bobinas */
        #bobina-a1 { transform: translate(140px); } /* 0 grados */
        #bobina-b1 { transform: rotate(60deg) translate(140px) rotate(-60deg); } /* 60 grados */
        #bobina-c1 { transform: rotate(120deg) translate(140px) rotate(-120deg); } /* 120 grados */
        #bobina-a2 { transform: translate(-140px); } /* 180 grados */
        #bobina-b2 { transform: rotate(240deg) translate(140px) rotate(-240deg); } /* 240 grados */
        #bobina-c2 { transform: rotate(300deg) translate(140px) rotate(-300deg); } /* 300 grados */
        
        /* Tarjeta de Estado */
        .estado-card {
            font-family: 'Courier New', Courier, monospace;
            background-color: var(--code-bg);
            color: var(--text-color);
            line-height: 1.8;
            font-size: 1.1em;
        }
        .estado-card strong {
            color: var(--primary-color);
            font-weight: 900;
        }
    </style>
</head>
<body>

    <h1>Simulador PaP (Bipolar / Medio Paso)</h1>

    <div class="simulador-card">
        <div id="estator">
            <div class="bobina" id="bobina-a1">A</div>
            <div class="bobina" id="bobina-b1">B</div>
            <div class="bobina" id="bobina-c1">C</div>
            <div class="bobina" id="bobina-a2">A</div>
            <div class="bobina" id="bobina-b2">B</div>
            <div class="bobina" id="bobina-c2">C</div>
            <div id="rotor"></div>
        </div>
    </div>

    <div class="controles">
        <button id="btn-paso-izq">Paso Izquierda</button>
        <button id="btn-paso-der">Paso Derecha</button>
        <button id="btn-girar-izq">Girar Izquierda</button>
        <button id="btn-girar-der">Girar Derecha</button>
        <button id="btn-detener" class="danger" disabled>Detener</button>
        <button id="darkModeToggle">üåô</button>
    </div>
    
    <div class="estado-card">
        <h2>Estado Actual</h2>
        <div>Pasos: <strong id="estado-paso">0 (Paso 0)</strong></div>
        <div>√Ångulo: <strong id="estado-angulo">0</strong>¬∞</div>
        <div>Fases Activas: <strong id="estado-fases">---</strong></div>
    </div>

    <script>
        // --- 1. CAPTURAR ELEMENTOS ---
        const rotor = document.getElementById('rotor');
        const modoOscuroBtn = document.getElementById('darkModeToggle');
        const estadoPaso = document.getElementById('estado-paso');
        const estadoAngulo = document.getElementById('estado-angulo');
        const estadoFases = document.getElementById('estado-fases');
        const btnPasoIzq = document.getElementById('btn-paso-izq');
        const btnPasoDer = document.getElementById('btn-paso-der');
        const btnGirarIzq = document.getElementById('btn-girar-izq');
        const btnGirarDer = document.getElementById('btn-girar-der');
        const btnDetener = document.getElementById('btn-detener');

        const bobinas = {
            a1: document.getElementById('bobina-a1'),
            b1: document.getElementById('bobina-b1'),
            c1: document.getElementById('bobina-c1'),
            a2: document.getElementById('bobina-a2'),
            b2: document.getElementById('bobina-b2'),
            c2: document.getElementById('bobina-c2')
        };
        const listaBobinas = Object.values(bobinas);
        const listaBotones = [btnPasoIzq, btnPasoDer, btnGirarIzq, btnGirarDer];

        // --- 2. ESTADO DEL MOTOR Y SECUENCIA ---
        const TOTAL_PASOS_CICLO = 12; // 12 pasos para una rotaci√≥n completa (360¬∞)
        const ANGULO_POR_PASO = 30; // 360 / 12

        // Secuencia Bipolar de Medio Paso (Half-Step)
        // 0 = OFF, 1 = Crea Polo NORTE (rojo pastel), -1 = Crea Polo SUR (celeste pastel)
        // L√≥gica:
        // El polo NORTE (rojo) del ROTOR es atra√≠do por BOBINAS SUR (celeste pastel).
        // El polo SUR (azul) del ROTOR es atra√≠do por BOBINAS NORTE (rojo pastel).
        
        // anguloRotor: Es el √°ngulo al que se alinear√° el polo NORTE (rojo) del rotor.
        // Si el anguloRotor es 0, significa que el polo NORTE del rotor est√° a 0 grados.
        // Esto ocurre cuando est√° atra√≠do por una bobina SUR (celeste) a 0 grados.
        const secuenciaPasos = [
            // {faseA_polarity, faseB_polarity, faseC_polarity, anguloRotor, textoFases}
            // Paso 0: Rotor (Norte) a 0¬∞. Atrae a bobina A (Sur) a 0¬∞.
            { fA: -1, fB: 0,  fC: 0,  anguloRotor: 0,   texto: "A (S)" }, 
            // Paso 1: Rotor (Norte) a 30¬∞. Atrae entre bobina A (Sur) a 0¬∞ y B (Sur) a 60¬∞.
            { fA: -1, fB: -1, fC: 0,  anguloRotor: 30,  texto: "A (S), B (S)" }, 
            // Paso 2: Rotor (Norte) a 60¬∞. Atrae a bobina B (Sur) a 60¬∞.
            { fA: 0,  fB: -1, fC: 0,  anguloRotor: 60,  texto: "B (S)" }, 
            // Paso 3: Rotor (Norte) a 90¬∞. Atrae entre bobina B (Sur) a 60¬∞ y C (Sur) a 120¬∞.
            { fA: 0,  fB: -1, fC: -1, anguloRotor: 90,  texto: "B (S), C (S)" }, 
            // Paso 4: Rotor (Norte) a 120¬∞. Atrae a bobina C (Sur) a 120¬∞.
            { fA: 0,  fB: 0,  fC: -1, anguloRotor: 120, texto: "C (S)" }, 
            // Paso 5: Rotor (Norte) a 150¬∞. Atrae entre bobina C (Sur) a 120¬∞ y A (Norte) a 180¬∞.
            // (El polo Sur del rotor es atra√≠do por la bobina A (Norte) a 180¬∞)
            { fA: 1,  fB: 0,  fC: -1, anguloRotor: 150, texto: "C (S), A (N)" }, 
            // Paso 6: Rotor (Norte) a 180¬∞. Atrae a bobina A (Norte) a 180¬∞. (El polo Sur del rotor se alinea con bobina A (Norte) a 180¬∞).
            { fA: 1,  fB: 0,  fC: 0,  anguloRotor: 180, texto: "A (N)" }, 
            // Paso 7: Rotor (Norte) a 210¬∞. Atrae entre bobina A (Norte) a 180¬∞ y B (Norte) a 240¬∞.
            { fA: 1,  fB: 1,  fC: 0,  anguloRotor: 210, texto: "A (N), B (N)" }, 
            // Paso 8: Rotor (Norte) a 240¬∞. Atrae a bobina B (Norte) a 240¬∞.
            { fA: 0,  fB: 1,  fC: 0,  anguloRotor: 240, texto: "B (N)" }, 
            // Paso 9: Rotor (Norte) a 270¬∞. Atrae entre bobina B (Norte) a 240¬∞ y C (Norte) a 300¬∞.
            { fA: 0,  fB: 1,  fC: 1,  anguloRotor: 270, texto: "B (N), C (N)" }, 
            // Paso 10: Rotor (Norte) a 300¬∞. Atrae a bobina C (Norte) a 300¬∞.
            { fA: 0,  fB: 0,  fC: 1,  anguloRotor: 300, texto: "C (N)" }, 
            // Paso 11: Rotor (Norte) a 330¬∞. Atrae entre bobina C (Norte) a 300¬∞ y A (Sur) a 0¬∞.
            { fA: -1, fB: 0,  fC: 1,  anguloRotor: 330, texto: "C (N), A (S)" }  
        ];

        let pasoActualCiclo = 0; // √çndice del ciclo (0 a 11)
        let anguloFisico = 0; // √Ångulo acumulativo del rotor
        let pasosTotales = 0; // Contador de pasos acumulativo
        
        let intervaloGiro = null;
        const VELOCIDAD_GIRO = 350; // ms por paso
        const RETARDO_MOVIMIENTO_ROTOR = 50; // ms de retardo (0.075s)

        // --- 3. FUNCIONES DEL MOTOR ---

        /** Apaga todas las bobinas (quita ambas clases de polaridad) */
        function apagarTodasLasBobinas() {
            listaBobinas.forEach(bobina => {
                bobina.classList.remove('energizada-norte');
                bobina.classList.remove('energizada-sur');
            });
        }

        /**
         * Aplica la polaridad correcta a un par de bobinas de fase (ej: A en 0¬∞ y A en 180¬∞).
         * @param {number} polaridad - 1 para Norte, -1 para Sur, 0 para Off.
         * @param {HTMLElement} bobinaPrincipal - La bobina en la posici√≥n primaria (ej: A a 0¬∞).
         * @param {HTMLElement} bobinaOpuesta - La bobina en la posici√≥n opuesta (ej: A a 180¬∞).
         * @param {string[]} fasesActivasArray - Array para el texto de estado.
         * @param {string} nombreFase - Nombre de la fase (A, B, C).
         */
        function energizarFase(polaridad, bobinaPrincipal, bobinaOpuesta, fasesActivasArray, nombreFase) {
            if (polaridad === 1) { // Esta fase crea un polo NORTE en la bobina principal, y SUR en la opuesta
                bobinaPrincipal.classList.add('energizada-norte');
                bobinaOpuesta.classList.add('energizada-sur'); // La opuesta siempre tiene el polo contrario
                fasesActivasArray.push(`${nombreFase} (N)`);
            } else if (polaridad === -1) { // Esta fase crea un polo SUR en la bobina principal, y NORTE en la opuesta
                bobinaPrincipal.classList.add('energizada-sur');
                bobinaOpuesta.classList.add('energizada-norte'); // La opuesta siempre tiene el polo contrario
                fasesActivasArray.push(`${nombreFase} (S)`);
            }
        }

        /**
         * Funci√≥n Central: Actualiza el estado visual del motor (bobinas y texto).
         * El movimiento del rotor se maneja con un retraso aparte.
         */
        function actualizarMotorVisual() {
            const paso = secuenciaPasos[pasoActualCiclo];
            let fasesTexto = [];
            
            // 1. Energizar/Desenergizar bobinas (L√≥gica Bipolar)
            apagarTodasLasBobinas();

            // Usamos las bobinas "primarias" y sus opuestas
            energizarFase(paso.fA, bobinas.a1, bobinas.a2, fasesTexto, 'A');
            energizarFase(paso.fB, bobinas.b1, bobinas.b2, fasesTexto, 'B');
            energizarFase(paso.fC, bobinas.c1, bobinas.c2, fasesTexto, 'C');
            
            // 2. Actualizar el texto de estado
            estadoPaso.textContent = `${pasosTotales} (Paso ${pasoActualCiclo})`;
            estadoAngulo.textContent = `${anguloFisico}¬∞`;
            estadoFases.textContent = fasesTexto.join(', ') || '---';
        }
        
        /** Mueve el rotor al √°ngulo f√≠sico actual */
        function moverRotor() {
            rotor.style.transform = `rotate(${anguloFisico}deg)`;
        }

        function pasoDerecha() {
            pasoActualCiclo = (pasoActualCiclo + 1) % TOTAL_PASOS_CICLO;
            anguloFisico += ANGULO_POR_PASO;
            pasosTotales++;
            
            actualizarMotorVisual(); // Bobinas cambian de color primero
            setTimeout(moverRotor, RETARDO_MOVIMIENTO_ROTOR); // Rotor se mueve despu√©s de un retardo
        }
        
        function pasoIzquierda() {
            pasoActualCiclo = (pasoActualCiclo - 1 + TOTAL_PASOS_CICLO) % TOTAL_PASOS_CICLO;
            anguloFisico -= ANGULO_POR_PASO;
            pasosTotales--;
            
            actualizarMotorVisual(); // Bobinas cambian de color primero
            setTimeout(moverRotor, RETARDO_MOVIMIENTO_ROTOR); // Rotor se mueve despu√©s de un retardo
        }
        
        function toggleControles(girando) {
            listaBotones.forEach(btn => btn.disabled = girando);
            btnDetener.disabled = !girando;
        }
        
        function girarDerecha() {
            detenerGiro();
            toggleControles(true);
            intervaloGiro = setInterval(pasoDerecha, VELOCIDAD_GIRO);
        }

        function girarIzquierda() {
            detenerGiro();
            toggleControles(true);
            intervaloGiro = setInterval(pasoIzquierda, VELOCIDAD_GIRO);
        }
        
        function detenerGiro() {
            clearInterval(intervaloGiro);
            intervaloGiro = null;
            toggleControles(false);
            apagarTodasLasBobinas(); 
            actualizarMotorVisual(); 
        }

        // --- 4. L√ìGICA DEL MODO OSCURO ---
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const esModoOscuro = document.body.classList.contains('dark-mode');
            modoOscuroBtn.textContent = esModoOscuro ? '‚òÄÔ∏è' : 'üåô';
        }

        // --- 5. ASIGNAR EVENTOS (Event Listeners) ---
        btnPasoDer.addEventListener('click', pasoDerecha);
        btnPasoIzq.addEventListener('click', pasoIzquierda);
        btnGirarDer.addEventListener('click', girarDerecha);
        btnGirarIzq.addEventListener('click', girarIzquierda);
        btnDetener.addEventListener('click', detenerGiro);
        modoOscuroBtn.addEventListener('click', toggleDarkMode);

        // --- 6. INICIALIZACI√ìN ---
        actualizarMotorVisual(); 
        moverRotor(); 

    </script>
</body>
</html>